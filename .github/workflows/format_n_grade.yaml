name: Code Formatting and Grading

on: [push, pull_request]

jobs:
    format-and-grade:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4

        - name: Update Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.13'

        - name: Install clang-format
          run: sudo apt update && sudo apt install -y clang-format

        - name: Formatting
          run: |
            # Get the list of changed files in the last commit/PR
            git diff --name-only HEAD^ HEAD | grep -E '\.(c|cpp|h|hpp)$' > changed_files.txt
            # Apply clang-format to changed files if any exist
            -    if [ -s changed_files.txt ]; then
              xargs clang-format -i -style=file < changed_files.txt
            fi
        
        - name: Commit formatted files
          env: ${{ secrets.GITHUB_TOKEN }}
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add .
            git diff --staged --quiet || git commit -m "Apply clang-format changes"
            git push
          continue-on-error: true

        - name: Grading
          run: |
            chmod +x ./grade-lab-util
            ./grade-lab-util

